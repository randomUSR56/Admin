<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Admin.ViewModels"
             xmlns:models="clr-namespace:Admin.Models"
             x:Class="Admin.Views.TicketsPage"
             x:DataType="vm:TicketsViewModel"
             Title="Tickets">

    <Grid RowDefinitions="Auto,*,Auto" Padding="20" RowSpacing="12">

        <!-- Filter Bar -->
        <Grid Grid.Row="0"
              ColumnDefinitions="*,*,Auto,Auto"
              ColumnSpacing="10">

            <Picker ItemsSource="{Binding AvailableStatuses}"
                    SelectedItem="{Binding SelectedStatus}"
                    Title="Status"
                    WidthRequest="150" />

            <Picker Grid.Column="1"
                    ItemsSource="{Binding AvailablePriorities}"
                    SelectedItem="{Binding SelectedPriority}"
                    Title="Priority"
                    WidthRequest="130" />

            <Button Grid.Column="2"
                    Text="Filter"
                    Command="{Binding FilterCommand}"
                    HeightRequest="40"
                    CornerRadius="6"
                    FontSize="13" />

            <Button Grid.Column="3"
                    Text="+ New Ticket"
                    Command="{Binding CreateTicketCommand}"
                    HeightRequest="40"
                    CornerRadius="6"
                    FontSize="13"
                    BackgroundColor="{StaticResource Primary}" />
        </Grid>

        <!-- Error -->
        <Border Grid.Row="1"
                Stroke="{StaticResource Red100Accent}"
                BackgroundColor="#33FF0000"
                StrokeShape="RoundRectangle 8"
                Padding="12"
                IsVisible="{Binding HasError}"
                VerticalOptions="Start">
            <Label Text="{Binding ErrorMessage}"
                   TextColor="{StaticResource Red100Accent}"
                   FontSize="13" />
        </Border>

        <!-- Tickets List -->
        <CollectionView Grid.Row="1"
                        ItemsSource="{Binding Tickets}"
                        IsVisible="{Binding HasError, Converter={StaticResource InvertBoolConverter}}">
            <CollectionView.EmptyView>
                <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Spacing="8">
                    <Label Text="No tickets found"
                           FontSize="16"
                           HorizontalTextAlignment="Center"
                           TextColor="{StaticResource Gray400}" />
                </VerticalStackLayout>
            </CollectionView.EmptyView>

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:Ticket">
                    <Border StrokeShape="RoundRectangle 8"
                            Padding="14"
                            Margin="0,4"
                            BackgroundColor="{StaticResource Gray900}">
                        <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,Auto" RowSpacing="6" ColumnSpacing="12">

                            <!-- Row 0: ID + Priority + Status badges -->
                            <HorizontalStackLayout Grid.Row="0" Grid.Column="0" Spacing="8">
                                <Label Text="{Binding Id, StringFormat='#{0}'}"
                                       FontSize="15"
                                       FontAttributes="Bold"
                                       VerticalOptions="Center" />

                                <Border StrokeShape="RoundRectangle 4"
                                        Padding="6,2"
                                        BackgroundColor="{Binding Priority, Converter={StaticResource TicketPriorityColorConverter}}"
                                        StrokeThickness="0">
                                    <Label Text="{Binding PriorityDisplay}"
                                           FontSize="11"
                                           TextColor="White" />
                                </Border>

                                <Border StrokeShape="RoundRectangle 4"
                                        Padding="6,2"
                                        BackgroundColor="{Binding Status, Converter={StaticResource TicketStatusColorConverter}}"
                                        StrokeThickness="0">
                                    <Label Text="{Binding StatusDisplay}"
                                           FontSize="11"
                                           TextColor="White" />
                                </Border>
                            </HorizontalStackLayout>

                            <!-- Row 0, Col 1: Action buttons -->
                            <HorizontalStackLayout Grid.Row="0" Grid.Column="1" Spacing="4">
                                <Button Text="Edit"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:TicketsViewModel}}, Path=ViewTicketCommand}"
                                        CommandParameter="{Binding .}"
                                        HeightRequest="30"
                                        CornerRadius="6"
                                        FontSize="11"
                                        Padding="10,0"
                                        VerticalOptions="Center" />

                                <Button Text="Delete"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:TicketsViewModel}}, Path=DeleteTicketCommand}"
                                        CommandParameter="{Binding .}"
                                        BackgroundColor="{StaticResource Red100Accent}"
                                        HeightRequest="30"
                                        CornerRadius="6"
                                        FontSize="11"
                                        Padding="10,0"
                                        VerticalOptions="Center" />
                            </HorizontalStackLayout>

                            <!-- Row 1: Description + Car/Owner -->
                            <VerticalStackLayout Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Spacing="3">
                                <Label Text="{Binding Description}"
                                       FontSize="13"
                                       MaxLines="2"
                                       LineBreakMode="TailTruncation" />
                                <HorizontalStackLayout Spacing="12">
                                    <Label Text="{Binding CarDisplay, StringFormat='ðŸš— {0}'}"
                                           FontSize="12"
                                           TextColor="{StaticResource Gray400}" />
                                    <Label Text="{Binding OwnerDisplay, StringFormat='ðŸ‘¤ {0}'}"
                                           FontSize="12"
                                           TextColor="{StaticResource Gray400}" />
                                    <Label Text="{Binding MechanicDisplay, StringFormat='ðŸ”§ {0}'}"
                                           FontSize="12"
                                           TextColor="{StaticResource Gray400}" />
                                </HorizontalStackLayout>
                            </VerticalStackLayout>

                            <!-- Row 2: Workflow buttons -->
                            <HorizontalStackLayout Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" Spacing="6">
                                <Button Text="Accept"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:TicketsViewModel}}, Path=AcceptTicketCommand}"
                                        CommandParameter="{Binding .}"
                                        IsVisible="{Binding Status, Converter={StaticResource BusyTextConverter}, ConverterParameter='open|True'}"
                                        HeightRequest="28"
                                        CornerRadius="5"
                                        FontSize="11"
                                        Padding="8,0"
                                        BackgroundColor="Orange" />
                                <Button Text="Start"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:TicketsViewModel}}, Path=StartTicketCommand}"
                                        CommandParameter="{Binding .}"
                                        HeightRequest="28"
                                        CornerRadius="5"
                                        FontSize="11"
                                        Padding="8,0"
                                        BackgroundColor="MediumPurple" />
                                <Button Text="Complete"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:TicketsViewModel}}, Path=CompleteTicketCommand}"
                                        CommandParameter="{Binding .}"
                                        HeightRequest="28"
                                        CornerRadius="5"
                                        FontSize="11"
                                        Padding="8,0"
                                        BackgroundColor="SeaGreen" />
                                <Button Text="Close"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:TicketsViewModel}}, Path=CloseTicketCommand}"
                                        CommandParameter="{Binding .}"
                                        HeightRequest="28"
                                        CornerRadius="5"
                                        FontSize="11"
                                        Padding="8,0"
                                        BackgroundColor="Gray" />
                            </HorizontalStackLayout>
                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Loading -->
        <ActivityIndicator Grid.Row="1"
                           IsRunning="{Binding IsBusy}"
                           IsVisible="{Binding IsBusy}"
                           Color="{StaticResource Primary}"
                           HorizontalOptions="Center"
                           VerticalOptions="Center" />

        <!-- Pagination -->
        <Grid Grid.Row="2"
              ColumnDefinitions="Auto,*,Auto"
              Padding="0,8,0,0">
            <Button Text="â† Previous"
                    Command="{Binding PreviousPageCommand}"
                    FontSize="13"
                    HeightRequest="36"
                    CornerRadius="6"
                    BackgroundColor="{StaticResource Gray600}" />

            <Label Grid.Column="1"
                   HorizontalTextAlignment="Center"
                   VerticalOptions="Center"
                   FontSize="13">
                <Label.Text>
                    <MultiBinding StringFormat="Page {0} of {1} ({2} total tickets)">
                        <Binding Path="CurrentPage" />
                        <Binding Path="LastPage" />
                        <Binding Path="TotalTickets" />
                    </MultiBinding>
                </Label.Text>
            </Label>

            <Button Grid.Column="2"
                    Text="Next â†’"
                    Command="{Binding NextPageCommand}"
                    FontSize="13"
                    HeightRequest="36"
                    CornerRadius="6"
                    BackgroundColor="{StaticResource Gray600}" />
        </Grid>
    </Grid>
</ContentPage>
